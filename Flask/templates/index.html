{% extends 'base.html' %}

{% block head %}
<title>Nodes</title>
{% endblock %}

{% block body %}
<header>
    <div class="header-content">
        <div class="title">
            <h1>Gestor de √Åudio</h1>
            <p>Hotel Montebelo</p>
        </div>
    </div>
</header>

<div class="container">
    <div class="content">
        <h2>Conex√µes Wi-Fi</h2>
    </div>
</div>

<div class="container centered-container">
    <div class="content">
        <div class="column-box" id="columnBox" style="display: block;">
            
            {% if nodes|length < 1 %}
            <h1>Nenhum n√≥ encontrado</h1>
            {% else %}
            <div class="column-list">
                {% for node in nodes %}
                <div class="column-item" onclick="toggleColumnDetails(this)">
                    <span>{{ node.name }}</span>
                    <div class="column-actions" onclick="event.stopPropagation()">
                        <i class="fa-solid fa-chevron-down" onclick="toggleColumnDetails(this)"></i>
                        <a href="/delete/{{ node.id }}"><i class="fa-solid fa-trash" style="color: black;"></i></a>
                    </div>
                    <script>
                    function toggleColumnDetails(icon) {
                        const columnItem = icon.closest('.column-item');
                        const details = columnItem.querySelector('.column-details');
                        const isHidden = (details.style.display === 'none' || !details.style.display);
                        details.style.display = isHidden ? 'block' : 'none';
                    }
                    document.addEventListener('DOMContentLoaded', () => {
                      document.querySelectorAll('.column-item').forEach(item => {
                        item.addEventListener('click', e => {
                          if (!e.target.closest('.column-actions')) {
                            toggleColumnDetails(item.querySelector('.fa-chevron-down'));
                          }
                        });
                      });
                    });
                    </script>

                    <div class="column-details" style="display: none;">
                        <p>IP: {{ node.ip }}</p>
                        <p>MAC: {{ node.mac }}</p>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>
    </div>
</div>

<div class="container">
    <div class="content">
        <h2>As minhas zonas</h2>
        <div class="zone-container">
            {% if areas|length < 1 %}
            <h1>No Areas</h1>
            {% else %}
            {% for area in areas %}
            <div class="zone-box">
                <div class="zone-header">
                    <h3>{{ area.name }}</h3>
                    <button onclick="removeArea('{{ area.name }}')"><i class="fa-solid fa-trash delete-zone"></i></button>
                    <form id="remove-area-form-{{ area.name }}" action="/remove_area" method="POST" style="display: none;">
                        <input type="hidden" name="name" value="{{ area.name }}">
                    </form>                    
                </div>
                <div class="zone-content">
                    <div class="column-section">
                        <h4>Colunas</h4>
                        <div class="column-list">
                            <div class="add-column" onclick="showSelectForZone(this)">
                                <span>+ Coluna</span>
                            </div>
                        </div>
                    </div>
                    <div class="channel-volume">
                        <div class="channel-section">
                            <h4>Canal</h4>
                            <div class="channel-options">
                                <form action="/update_area_channel" method="POST" id="channelForm">
                                    <input type="hidden" name="name" value="{{ area.name }}">
                                    
                                    <label>
                                        <input type="radio" name="channel_id" value="1"
                                            {% if area.channel_id == 1 %} checked {% endif %} style="accent-color: #22cc3f;"> Canal 1
                                    </label>
                                    
                                    <label>
                                        <input type="radio" name="channel_id" value="2"
                                            {% if area.channel_id == 2 %} checked {% endif %} style="accent-color: #22cc3f;"> Canal 2
                                    </label>
                                    
                                    <label>
                                        <input type="radio" name="channel_id" value="3"
                                            {% if area.channel_id == 3 %} checked {% endif %} style="accent-color: #22cc3f;"> Canal 3
                                    </label>
                                </form>
                            </div>
                        </div>
                        <div class="volume-section">
                            <h4>Volume</h4>
                            <form action="/update_volume" method="POST" class="volume-form">
                                <input type="hidden" name="name" value="{{ area.name }}">
                                <input type="range" name="volume" min="0" max="100" value="{{ area.volume }}" id="volume-slider">
                                <p id="volume-label">Volume: {{ area.volume }}%</p>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
            {% endif %}
            <div class="zone-box add-zone" id="addAreaButton" onclick="addArea() ">
                <span>+</span>
            </div>
            
        </div>
    </div>
</div>


<div class="container">
    <div class="content">
        <h2>Os meus Canais</h2>
    </div>
</div>

<div class="container centered-container">
    <div class="content">
        <div class="channels-content">
            {% if channels|length < 1 %}
            <h1>No Channels</h1>
            {% else %}
            
            <div class="channels-container">
                {% for channel in channels %}
                <div class="channel-group">
                    <label for="channel{{ channel.id }}">Canal {{ channel.id }}:</label>
                    <div class="channel-options">
                        <form id="form_{{ channel.id }}" action="/update_channel/{{ channel.id }}" method="POST">
                            <label>
                                <input type="radio" name="channel_type" value="LOCAL"
                                    {% if channel.type.value == 'LOCAL' %} checked {% endif %}
                                    style="accent-color: #22cc3f;"> Local
                            </label>
                            <label>
                                <input type="radio" name="channel_type" value="STREAMING"
                                    {% if channel.type.value == 'STREAMING' %} checked {% endif %}
                                    style="accent-color: #22cc3f;"> Transmiss√£o
                            </label>
                            <label>
                                <input type="radio" name="channel_type" value="VOICE"
                                    {% if channel.type.value == 'VOICE' %} checked {% endif %}
                                    style="accent-color: #22cc3f;"> Voz
                            </label>
                        </form>
                    </div>
                </div>
                {% endfor %}
            </div>
            
            {% endif %}
        </div>
    </div>
</div>











<script>
    //to change the volume of the area
    document.getElementById('volume-slider').addEventListener('change', function() {
    let volume = this.value;
    let areaName = document.querySelector('input[name="name"]').value;

    // Update label dynamically
    document.getElementById('volume-label').textContent = `Volume: ${volume}%`;

    // Send the updated volume to the server
    fetch('/update_volume', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: `name=${encodeURIComponent(areaName)}&volume=${encodeURIComponent(volume)}`
    }).then(response => console.log(`Volume updated to ${volume}`));
    });

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    //to change the channel type
    document.querySelectorAll('input[type="radio"]').forEach((radio) => {
        radio.addEventListener('change', function() {
            const channelId = this.closest('form').id.split('_')[1]; // Extract channel ID from form ID
            const form = document.getElementById(`form_${channelId}`);
            
            // Auto-submit the form
            form.submit();
        });
    });

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    //to change the channel of the area
    document.querySelectorAll('input[type="radio"]').forEach((radio) => {
        radio.addEventListener('change', function() {
            // Get the closest form and submit it
            const form = this.closest('form');
            form.submit();
        });
    });

function addArea() {
    const areaName = prompt("Nome da nova √°rea:");

    if (!areaName) {
        alert("O nome da √°rea √© obrigat√≥rio!");
        return;
    }

    fetch('/add_area', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ name: areaName }) 
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(data => { throw new Error(data.error); });
        }
        return response.json();
    })
    .then(data => {
        alert("√Årea adicionada com sucesso!");
        location.reload();
    })
    .catch(error => {
        alert("Erro: " + error.message);
    });
}


document.addEventListener("DOMContentLoaded", function () {
    // Lista de colunas j√° associadas a zonas
    let usedZoneColumns = [];

    // Adicionar funcionalidade ao bot√£o "+ Coluna"
    document.querySelectorAll(".add-column").forEach(button => {
        button.addEventListener("click", function () {
            showSelectForZone(this);
        });
    });

    // Adicionar funcionalidade de remo√ß√£o √†s colunas existentes
    document.querySelectorAll(".delete-column").forEach(btn => {
        btn.addEventListener("click", function (event) {
            event.stopPropagation(); // Evita ativa√ß√£o da sele√ß√£o ao clicar no √≠cone de remo√ß√£o
            const columnItem = this.closest(".column-item");
            removeZoneColumn(columnItem);
        });
    });

    // Controle de volume
    document.querySelectorAll("input[type='range']").forEach(slider => {
        slider.addEventListener("input", function () {
            this.nextElementSibling.textContent = `Volume: ${this.value}%`;
        });
    });

    // Fun√ß√£o para exibir o seletor de colunas Wi-Fi ao clicar em "+ Coluna"
    function showSelectForZone(buttonElement) {
        // Criar container para sele√ß√£o
        const container = document.createElement("div");
        container.classList.add("select-container");

        // Criar dropdown de sele√ß√£o
        const select = document.createElement("select");
        select.classList.add("select-column");

        // Adicionar op√ß√£o padr√£o
        const defaultOption = document.createElement("option");
        defaultOption.value = "";
        defaultOption.disabled = true;
        defaultOption.selected = true;
        defaultOption.textContent = "Selecione uma coluna";
        select.appendChild(defaultOption);

        // Obter colunas Wi-Fi dispon√≠veis (excluindo as j√° usadas)
        const wifiColumns = document.querySelectorAll("#columnBox .column-item");
        wifiColumns.forEach(column => {
            const colName = column.querySelector("span").textContent.replace("‚úî ", "").trim();
            if (!usedZoneColumns.includes(colName)) {
                const option = document.createElement("option");
                option.value = colName;
                option.textContent = colName;
                select.appendChild(option);
            }
        });

        // Criar bot√£o de cancelamento
        const cancelButton = document.createElement("button");
        cancelButton.classList.add("cancel-button");
        cancelButton.textContent = "X";
        cancelButton.addEventListener("click", function () {
            container.replaceWith(buttonElement); // Reverte ao bot√£o original
        });

        // Adicionar elementos ao container
        container.appendChild(select);
        container.appendChild(cancelButton);

        // Substituir o bot√£o "+" pelo dropdown
        buttonElement.replaceWith(container);

        // Ao selecionar uma coluna, adicion√°-la √† zona
        select.addEventListener("change", function () {
            addZoneColumn(select, buttonElement);
        });
    }

    // Fun√ß√£o para adicionar coluna √† zona
    function addZoneColumn(selectElement, buttonElement) {
        const selectedColumn = selectElement.value;
        if (!selectedColumn) return;

        const zoneName = selectElement.closest(".zone-box").querySelector("h3").textContent.trim();

        // Criar elemento visual da coluna na zona
        const columnItem = document.createElement("div");
        columnItem.classList.add("column-item");
        columnItem.innerHTML = `
            <span>${selectedColumn}</span>
            <button class="delete-column">üóëÔ∏è</button>
        `;

        // Adicionar evento para remover coluna
        columnItem.querySelector(".delete-column").addEventListener("click", function () {
            removeZoneColumn(columnItem, selectedColumn, zoneName);
        });

        // Adicionar a nova coluna ao container e restaurar bot√£o "+"
        const zoneContainer = selectElement.closest(".column-list");
        zoneContainer.insertBefore(columnItem, selectElement.parentElement);
        selectElement.parentElement.replaceWith(buttonElement);

        // Marcar coluna como usada
        usedZoneColumns.push(selectedColumn);

        // Enviar para o backend
        fetch("/add_column_to_zone", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ zone_name: zoneName, column_name: selectedColumn })
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert("Erro: " + data.error);
                columnItem.remove(); // Se falhar, remove do frontend tamb√©m
                usedZoneColumns = usedZoneColumns.filter(name => name !== selectedColumn);
            }
        })
        .catch(error => console.error("Erro ao adicionar coluna:", error));
    }


    // Fun√ß√£o para remover uma coluna da zona
    function removeZoneColumn(columnElement) {
        const colName = columnElement.querySelector("span").textContent.trim();
        usedZoneColumns = usedZoneColumns.filter(name => name !== colName);
        columnElement.remove();
    }
});




document.getElementById("addAreaButton").addEventListener("click", addArea);


    document.addEventListener("DOMContentLoaded", function () {
        const columnBox = document.getElementById("columnBox");
    
        window.toggleColumnDetails = function(icon) {
            const columnItem = icon.closest(".column-item");
            const details = columnItem.querySelector(".column-details");
            const isHidden = (details.style.display === 'none' || !details.style.display);
            details.style.display = isHidden ? 'block' : 'none';
        };
    
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.column-item').forEach(item => {
              item.addEventListener('click', e => {
                if (!e.target.closest('.column-actions')) {
                  toggleColumnDetails(item.querySelector('.fa-chevron-down'));
                }
              });
            });
        });
    
        // Ensure only one channel can be selected per zone
        window.selectSingleChannel = function(checkbox) {
            const checkboxes = document.querySelectorAll(`input[name="${checkbox.name}"]`);
            checkboxes.forEach((cb) => {
                if (cb !== checkbox) cb.checked = false;
            });
        };
    
        // Fun√ß√£o para remover uma √°rea
        window.removeArea = function(areaName) {
            const form = document.getElementById(`remove-area-form-${areaName}`);
            form.submit();
        };
    
        // Fun√ß√£o para mostrar o modal de adi√ß√£o de √°rea
        window.showAddAreaModal = function() {
            document.getElementById("addAreaModal").style.display = "block";
        };
    
        // Fun√ß√£o para fechar o modal de adi√ß√£o de √°rea
        window.closeAddAreaModal = function() {
            document.getElementById("addAreaModal").style.display = "none";
        };
    
        // Fun√ß√£o para adicionar uma nova √°rea
        window.addArea = function() {
            const areaName = document.getElementById("area_name").value;
            const channelId = document.getElementById("channel_id").value;
            const volume = document.getElementById("volume").value;
            const nodeIds = Array.from(document.getElementById("node_ids").selectedOptions).map(option => option.value);
    
            if (!areaName || !channelId || !volume) {
                alert("All fields are required!");
                return;
            }
    
            fetch('/add_area', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ name: areaName, channel_id: channelId, volume: volume, node_ids: nodeIds })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert("√Årea adicionada com sucesso!");
                    location.reload(); // Atualiza a p√°gina para mostrar a nova √°rea
                } else {
                    alert("Erro: " + data.error);
                }
            })
            .catch(error => console.error("Erro ao adicionar √°rea:", error));
        };
    });
    </script>
{% endblock %}